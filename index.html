<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOO Cat Tracker - UX Professional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --up-accent: #00c805;    
            --down-accent: #ff3b30;  
            --text-black: #000000;   
            --digit-h: 80px; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif; 
            background-color: #f8fafb; color: var(--text-black);
            text-align: center; padding: 10px; margin: 0;
        }
        
        .card {
            background: #ffffff; border-radius: 28px; padding: 24px 20px; 
            box-shadow: 0 4px 25px rgba(0,0,0,0.06); 
            width: 92%; max-width: 360px; margin: 12px auto;
            position: relative; box-sizing: border-box;
        }

        /* Ê®ôÈ°åÁΩÆ‰∏≠ + ÊåâÈàïÁµïÂ∞çÈù†Âè≥ */
        .header-controls { 
            display: flex; align-items: center; justify-content: center; 
            position: relative; height: 40px; margin-bottom: 5px; 
        }
        .title-top { 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-size: 10px; color: #888; font-weight: 800; 
            letter-spacing: 1.2px; text-transform: uppercase; white-space: nowrap;
        }
        #auth-container { position: absolute; right: 0; top: 50%; transform: translateY(-50%); display: flex; align-items: center; }

        .ctrl-btn {
            background: #f5f5f5; border: none; border-radius: 10px;
            padding: 6px 12px; cursor: pointer; font-size: 11px; 
            font-weight: 800; color: var(--text-black); transition: 0.2s;
        }
        .ctrl-btn:hover { background: #eeeeee; }

        .portfolio-empty {
            background: #f9f9f9; padding: 22px; border-radius: 20px;
            font-size: 12px; color: #666; font-weight: 600; cursor: pointer;
            border: 2px dashed #eee; transition: 0.2s; text-align: center;
        }

        #cat-wrapper { height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 35px; margin-bottom: 10px; }
        #cat-container { width: 90px; height: 90px; }
        #cat-container svg { width: 100%; height: 100%; display: block; }

        .odometer { display: flex; justify-content: center; align-items: center; font-weight: 800; font-size: 50px; height: var(--digit-h); overflow: hidden; }
        .symbol { font-size: 26px; margin-right: 4px; font-weight: 800; }
        .digit-container { position: relative; width: 0.62em; height: var(--digit-h); overflow: hidden; }
        .digit-strip { position: absolute; width: 100%; transition: transform 0.8s cubic-bezier(0.23, 1, 0.32, 1); }
        .digit-strip span { display: block; height: var(--digit-h); line-height: var(--digit-h); }

        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .port-label { font-size: 9px; color: #888; font-weight: 700; margin-bottom: 3px; text-align: left; }
        .port-val { font-size: 13px; font-weight: 800; text-align: left; }

        /* Ê≠∑Âè≤Á¥ÄÈåÑÊ∏ÖÂñÆÊ®£Âºè */
        #history-panel { display: none; margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 15px; }
        #tx-list-container { max-height: 200px; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; }

        #holdings-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 10px; margin-top: 15px; text-align: left; font-size: 9px; }
        .hold-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        #success-popup {
            display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; padding: 16px 24px; border-radius: 100px;
            font-size: 12px; font-weight: 700; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: opacity 0.4s;
        }

        #input-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center;
        }
        .modal-box { background: white; padding: 25px; border-radius: 28px; width: 85%; max-width: 320px; text-align: left; }
        .up-text { color: var(--up-accent) !important; }
        .down-text { color: var(--down-accent) !important; }
    </style>
</head>
<body>

    <div id="success-popup">Sync active. Data secured.</div>

    <div class="card">
        <div class="header-controls">
            <div class="title-top">VOO MARKET TRACKER</div>
            <div id="auth-container">
                <button id="auth-btn" class="ctrl-btn" onclick="handleAuthClick()">Login</button>
            </div>
            <div id="g_id_onload"
                 data-client_id="45225026048-ka4ujv4omrve3o3840f7j5vklcit4vld.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
        </div>
        
        <div id="cat-wrapper">
            <div id="cat-container">
                <svg viewBox="0 0 100 100" width="100%" height="100%"><text x="50" y="75" font-size="50" text-anchor="middle">üê±</text></svg>
            </div>
        </div>

        <div class="odometer" id="odometer">
            <span class="symbol">$</span>
            <div id="digits-box" style="display:flex;"></div>
        </div>
        <div id="change-display"><span id="change-text" style="font-weight: 800; font-size: 14px;">---</span></div>
    </div>

    <div class="card" id="portfolio-section">
        <div id="portfolio-logged-out" onclick="handleAuthClick()" class="portfolio-empty">
            Sign in to record your purchase price and track performance.
        </div>
        
        <div id="portfolio-logged-in" style="display:none; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <span class="section-title" style="font-size:13px; font-weight:800; margin:0">Portfolio Tracking</span>
                <div style="display:flex; gap:6px;">
                    <button class="ctrl-btn" onclick="toggleHistory()" style="background:#eee;">History</button>
                    <button class="ctrl-btn" onclick="openAddModal()" style="background:#000; color:#fff;">+ Add Record</button>
                </div>
            </div>
            <div class="summary-grid">
                <div class="port-item"><div class="port-label">EST. VALUE</div><div class="port-val" id="total-val">$0.00</div></div>
                <div class="port-item"><div class="port-label">TOTAL P/L</div><div class="port-val" id="profit-val">--</div></div>
                <div class="port-item"><div class="port-label">RETURN</div><div class="port-val" id="return-pct">--%</div></div>
            </div>

            <div id="history-panel">
                <div style="font-size:10px; font-weight:800; margin-bottom:10px; color:#aaa;">PURCHASE HISTORY</div>
                <div id="tx-list-container"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="header-controls" style="justify-content: flex-start;">
            <div class="section-title" style="margin:0; font-size:13px; font-weight:800;">Price Trend <span id="api-status" style="font-size:9px; color:#bbb; font-weight:normal;">Simulated</span></div>
        </div>
        <div style="height: 180px; margin-top: 15px;"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="card">
        <div class="section-title" style="font-size:13px; font-weight:800; margin-bottom:12px;">Top 20 Holdings</div>
        <div style="width: 130px; margin: 0 auto;"><canvas id="holdingsChart"></canvas></div>
        <div id="holdings-list"></div>
    </div>

    <div id="input-modal">
        <div class="modal-box">
            <h3 id="modal-title" style="margin:0 0 20px 0; font-size:16px;">New Purchase</h3>
            <div style="background:#f9f9f9; padding:18px; border-radius:20px; margin-bottom:15px;">
                <label style="font-size:10px; font-weight:800;">DATE</label>
                <input type="date" id="tx-date" style="width:100%; margin:4px 0 10px; padding:8px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
                
                <label style="font-size:10px; font-weight:800;">PRICE PER SHARE ($)</label>
                <input type="number" id="tx-price" placeholder="634.02" style="width:100%; margin:4px 0 10px; padding:8px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
                
                <label style="font-size:10px; font-weight:800;">TOTAL INVESTMENT ($)</label>
                <input type="number" id="tx-total-amt" placeholder="1000.00" style="width:100%; margin:4px 0 14px; padding:8px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
                
                <button id="save-tx-btn" onclick="saveTransaction()" style="width:100%; background:#000; color:#fff; border:none; padding:12px; border-radius:12px; font-weight:800;">Save Record</button>
            </div>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#999; margin-top:5px; cursor:pointer; font-size:12px;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase ÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyBG0O6iJMyWTHiQ6yBZlzFEwxnZXl39vow",
            authDomain: "voo-tracker-8a51a.firebaseapp.com",
            databaseURL: "https://voo-tracker-8a51a-default-rtdb.firebaseio.com",
            projectId: "voo-tracker-8a51a",
            storageBucket: "voo-tracker-8a51a.firebasestorage.app",
            messagingSenderId: "947007261548",
            appId: "1:947007261548:web:1ef834f12313e55bc00149"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const API_KEY = 'd6ca1e9r01qsiik1clhgd6ca1e9r01qsiik1cli0'; 
        const symbol = 'VOO';
        let lastPrice = 0, trendChart = null, transactions = [], currentUserId = null, isDataReady = false, editingTxId = null;

        // ÁôªÂÖ•ÊåÅ‰πÖÂåñÊÅ¢Âæ©
        window.onload = () => {
            const saved = localStorage.getItem('voo_patty_auth');
            if (saved) { currentUserId = saved; showLoginUI(); connectFirebase(); }
            initApp();
        };

        window.handleAuthClick = () => {
            if (currentUserId) { if(confirm("Logout?")) { localStorage.removeItem('voo_patty_auth'); location.reload(); } }
            else { google.accounts.id.prompt(); }
        };

        window.handleCredentialResponse = (response) => {
            const payload = JSON.parse(window.atob(response.credential.split('.')[1]));
            currentUserId = payload.sub;
            localStorage.setItem('voo_patty_auth', currentUserId);
            showLoginUI(); connectFirebase();
        };

        function showLoginUI() {
            document.getElementById("auth-btn").innerText = "Logout";
            document.getElementById("portfolio-logged-out").style.display = "none";
            document.getElementById("portfolio-logged-in").style.display = "block";
        }

        function connectFirebase() {
            onValue(ref(db, 'users/' + currentUserId + '/transactions'), (snap) => {
                transactions = snap.val() || [];
                isDataReady = true;
                renderTxList(); calculatePortfolio();
            });
        }

        // ‰∫§ÊòìÊìç‰ΩúÈÇèËºØ
        window.openAddModal = () => {
            editingTxId = null;
            document.getElementById('modal-title').innerText = "New Purchase";
            document.getElementById('save-tx-btn').innerText = "Save Record";
            document.getElementById('tx-date').valueAsDate = new Date();
            document.getElementById('tx-price').value = "";
            document.getElementById('tx-total-amt').value = "";
            document.getElementById('input-modal').style.display = 'flex';
        };

        window.saveTransaction = () => {
            if (!isDataReady) return;
            const d = document.getElementById('tx-date').value, p = parseFloat(document.getElementById('tx-price').value), amt = parseFloat(document.getElementById('tx-total-amt').value);
            if(!d || isNaN(p) || isNaN(amt)) return;

            const entryData = { id: editingTxId || Date.now(), date: d, price: p, shares: amt / p };

            if (editingTxId) {
                transactions = transactions.map(t => t.id === editingTxId ? entryData : t);
            } else {
                transactions.push(entryData);
            }
            
            if (currentUserId) set(ref(db, 'users/' + currentUserId + '/transactions'), transactions);
            closeModal();
            renderTxList(); calculatePortfolio();
        };

        window.editTx = (id) => {
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;
            editingTxId = id;
            document.getElementById('modal-title').innerText = "Edit Record";
            document.getElementById('save-tx-btn').innerText = "Update Record";
            document.getElementById('tx-date').value = tx.date;
            document.getElementById('tx-price').value = tx.price;
            document.getElementById('tx-total-amt').value = (tx.price * tx.shares).toFixed(2);
            document.getElementById('input-modal').style.display = 'flex';
        };

        window.deleteTx = (id) => { 
            if(confirm("Delete this record?")) { 
                transactions = transactions.filter(t => t.id !== id); 
                if (currentUserId) set(ref(db, 'users/' + currentUserId + '/transactions'), transactions);
            } 
        };

        window.toggleHistory = () => {
            const p = document.getElementById('history-panel');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
        };

        window.closeModal = () => document.getElementById('input-modal').style.display = 'none';

        function renderTxList() {
            const container = document.getElementById('tx-list-container');
            container.innerHTML = transactions.length === 0 ? '<div style="font-size:11px; color:#ccc; text-align:center;">No records yet</div>' : '';
            [...transactions].sort((a,b) => b.id - a.id).forEach(t => {
                const total = (t.shares * t.price).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                container.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:10px; padding:12px; background:#f9f9f9; border-radius:15px; text-align:left;">
                <div style="flex:1;"><b style="font-size:12px;">$${total}</b><br><small style="color:#888;">${t.shares.toFixed(3)} shares @ $${t.price}</small></div>
                <div style="text-align:right;">
                    <small style="color:#bbb; font-weight:700;">${t.date}</small><br>
                    <div style="margin-top:4px;">
                        <span onclick="editTx(${t.id})" style="color:#007aff; cursor:pointer; font-weight:800; font-size:10px; margin-right:8px;">EDIT</span>
                        <span onclick="deleteTx(${t.id})" style="color:#ff3b30; cursor:pointer; font-weight:800; font-size:10px;">DEL</span>
                    </div>
                </div></div>`;
            });
        }

        function calculatePortfolio() {
            if(lastPrice <= 0 || transactions.length === 0) return;
            let cost = 0, shares = 0;
            transactions.forEach(t => { cost += (t.price * t.shares); shares += t.shares; });
            const val = lastPrice * shares, profit = val - cost, roi = ((val / cost) - 1) * 100;
            document.getElementById('total-val').innerText = `$${val.toLocaleString(undefined, {maximumFractionDigits:2})}`;
            const pEl = document.getElementById('profit-val'), rEl = document.getElementById('return-pct');
            pEl.innerText = `${profit >= 0 ? '+' : ''}$${profit.toLocaleString(undefined, {maximumFractionDigits:2})}`;
            pEl.className = `port-val ${profit >= 0 ? 'up-text' : 'down-text'}`;
            rEl.innerText = `${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%`;
            rEl.className = `port-val ${roi >= 0 ? 'up-text' : 'down-text'}`;
        }

        async function getVOOHistory() {
            const to = Math.floor(Date.now() / 1000);
            let from = to - (5 * 86400 * 3), res = '60';
            try {
                const response = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=${res}&from=${from}&to=${to}&token=${API_KEY}`);
                const data = await response.json();
                if (data.s === "ok" && data.c) {
                    const labels = data.t.slice(-40).map(ts => {
                        const d = new Date(ts * 1000);
                        return `${d.getMonth()+1}/${d.getDate()}`; // M/D Ê†ºÂºè
                    });
                    renderTrendChart(data.c.slice(-40), labels);
                } else { throw new Error(); }
            } catch (e) {
                document.getElementById('api-status').innerText = "Simulated";
                const base = lastPrice || 634, prices = [], labels = [];
                const now = new Date();
                for(let i=7; i>=0; i--) {
                    const d = new Date(); d.setDate(now.getDate() - i);
                    labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                    prices.push(base - (Math.random()*15 - 7.5));
                }
                renderTrendChart(prices, labels);
            }
        }

        function renderTrendChart(prices, labels) {
            if (trendChart) trendChart.destroy();
            const ctx = document.getElementById('trendChart').getContext('2d');
            const isUp = prices[prices.length-1] >= prices[0];
            trendChart = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: prices, borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#fff', pointBorderWidth: 2, tension: 0.2, fill: true,
                        borderColor: isUp ? '#00c805' : '#ff3b30',
                        backgroundColor: isUp ? 'rgba(0, 200, 5, 0.05)' : 'rgba(255, 59, 48, 0.05)'
                    }] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { display: true, ticks: { color: '#bbb', font: { size: 9, weight: '600' } }, grid: { display: false } }, 
                        y: { display: true, position: 'right', ticks: { color: '#000', font: { weight: '800', size: 10 } }, min: Math.min(...prices)*0.995, max: Math.max(...prices)*1.005 } 
                    } 
                } 
            });
        }

        async function updatePrice() {
            try {
                const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`);
                const data = await res.json();
                if (!data.c) return;
                lastPrice = data.c;
                updateOdometer(data.c.toFixed(2));
                calculatePortfolio();
                const isUp = data.d >= 0;
                document.getElementById('cat-container').innerHTML = `<svg viewBox="0 0 100 100" width="100%" height="100%"><text x="50" y="30" font-size="30" text-anchor="middle" fill="${isUp?'#00c805':'#ff3b30'}" font-weight="bold">${isUp?'‚ñ≤':'‚ñº'}</text><text x="50" y="75" font-size="50" text-anchor="middle">${isUp?'üò∫':'üòø'}</text></svg>`;
                document.body.style.backgroundColor = isUp ? "#f2faf5" : "#fef2f2";
                document.getElementById('change-text').innerText = `${isUp?'+':''}${data.d.toFixed(2)} (${data.dp.toFixed(2)}%)`;
                document.getElementById('change-text').className = isUp ? 'up-text' : 'down-text';
            } catch (e) {}
        }

        function updateOdometer(p) {
            const box = document.getElementById('digits-box');
            if (box.children.length === 0) {
                [...p].forEach(c => {
                    const el = document.createElement('div');
                    if (c === '.') { el.className = 'decimal-point'; el.innerText = '.'; }
                    else { el.className = 'digit-container'; el.innerHTML = `<div class="digit-strip"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span></div>`; }
                    box.appendChild(el);
                });
            }
            const strips = document.querySelectorAll('.digit-strip'), digits = [...p].filter(c => c !== '.');
            digits.forEach((d, i) => { if(strips[i]) strips[i].style.transform = `translateY(${-(parseInt(d) * 80)}px)`; });
        }

        function initApp() {
            const colors = ['#84a59d', '#a8dadc', '#9eb3c2', '#b7b7a4', '#ddbea9', '#cb997e', '#b5838d', '#e5989b', '#ffb5a7', '#fcd5ce', '#f8ad9d', '#f4978e', '#bc4749', '#6b705c', '#a5a58d', '#b7b7a4', '#ffe8d6', '#ddbea9', '#cb997e', '#9b2226'];
            const top20 = { labels: ["NVIDIA", "Apple", "Microsoft", "Amazon", "Alphabet A", "Alphabet C", "Meta", "Broadcom", "Tesla", "Berkshire", "Walmart", "Eli Lilly", "JPMorgan", "ExxonMobil", "Visa", "J&J", "Micron", "Mastercard", "Oracle", "Costco"], values: [7.32, 6.14, 4.72, 3.60, 3.11, 2.91, 2.65, 2.55, 2.46, 1.71, 1.57, 1.52, 1.34, 1.00, 0.99, 0.93, 0.76, 0.75, 0.70, 0.70] };
            new Chart(document.getElementById('holdingsChart').getContext('2d'), { type: 'doughnut', data: { labels: top20.labels, datasets: [{ data: top20.values, backgroundColor: colors, borderWidth: 1, borderColor: '#fff' }] }, options: { cutout: '70%', plugins: { legend: { display: false } } } });
            top20.labels.forEach((l, i) => document.getElementById('holdings-list').innerHTML += `<div class="hold-item"><div class="dot" style="background:${colors[i]}"></div><div style="flex:1;">${l} <b style="float:right">${top20.values[i]}%</b></div></div>`);
            updatePrice(); setInterval(updatePrice, 15000); getVOOHistory();
        }
    </script>
</body>
</html>
